<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‚ ì”¨ ì•±</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0b1120;
      --surface: rgba(255,255,255,0.06);
      --surface2: rgba(255,255,255,0.10);
      --border: rgba(255,255,255,0.10);
      --border2: rgba(255,255,255,0.18);
      --text: #f0f4ff;
      --muted: rgba(240,244,255,0.5);
      --accent: #60a5fa;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      transition: background 0.8s ease;
    }

    /* â”€â”€ Dynamic backgrounds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body.bg-clear    { background: linear-gradient(160deg, #0f2027, #203a43, #2c5364); }
    body.bg-cloudy   { background: linear-gradient(160deg, #1c1c2e, #2d2d44, #4a4a6a); }
    body.bg-rain     { background: linear-gradient(160deg, #0d1b2a, #1b2838, #1e3a5f); }
    body.bg-snow     { background: linear-gradient(160deg, #1a1a2e, #2d3561, #3d5a80); }
    body.bg-fog      { background: linear-gradient(160deg, #1a1a1a, #2d2d2d, #3a3a3a); }
    body.bg-thunder  { background: linear-gradient(160deg, #0d0d1a, #1a0d2e, #2d1b4e); }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wrap {
      max-width: 680px;
      margin: 0 auto;
      padding: 32px 20px 60px;
    }

    /* â”€â”€ Tab + controls row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .tab-group {
      display: flex;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 12px;
      padding: 4px;
      gap: 4px;
      flex-shrink: 0;
    }

    .tab-btn {
      height: 36px;
      padding: 0 18px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s, color .2s;
      background: transparent;
      color: var(--muted);
    }
    .tab-btn.active {
      background: var(--accent);
      color: #fff;
    }
    .tab-btn:not(.active):hover { color: var(--text); }

    .spacer { flex: 1; }

    .loc-btn {
      height: 44px;
      width: 44px;
      flex-shrink: 0;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 12px;
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .2s, border-color .2s;
    }
    .loc-btn:hover { background: var(--surface); border-color: var(--accent); }
    .loc-btn:disabled { opacity: .45; cursor: default; }

    .unit-btn {
      height: 44px;
      padding: 0 14px;
      flex-shrink: 0;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 12px;
      color: var(--text);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s;
    }
    .unit-btn:hover { background: var(--surface); }

    /* â”€â”€ Korea city grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .city-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 28px;
    }

    @media (max-width: 440px) {
      .city-grid { grid-template-columns: repeat(4, 1fr); }
    }

    .city-btn {
      padding: 10px 6px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: background .15s, border-color .15s;
    }
    .city-btn:hover  { background: var(--surface); border-color: var(--border2); }
    .city-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(96,165,250,0.1); }

    /* ì§ì ‘ ì…ë ¥ ë²„íŠ¼ */
    .city-btn-manual { border-style: dashed; color: var(--muted); }
    .city-btn-manual.active { border-style: solid; border-color: var(--accent); color: var(--accent); background: rgba(96,165,250,0.1); }

    /* â”€â”€ Coord input form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .coord-form {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .coord-inputs { display: flex; gap: 12px; }

    @media (max-width: 440px) {
      .coord-inputs { flex-direction: column; }
    }

    .coord-field { flex: 1; display: flex; flex-direction: column; gap: 6px; }

    .coord-label { font-size: 12px; color: var(--muted); font-weight: 600; letter-spacing: 0.3px; }

    .coord-input {
      height: 44px;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      padding: 0 14px;
      outline: none;
      transition: border-color .2s;
    }
    .coord-input::placeholder { color: var(--muted); }
    .coord-input:focus { border-color: var(--accent); }

    .coord-err { font-size: 13px; color: #f87171; margin-top: -4px; }

    /* â”€â”€ Global search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 28px;
    }

    .search-box {
      position: relative;
      flex: 1;
    }

    .search-input {
      width: 100%;
      height: 48px;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 12px;
      color: var(--text);
      font-size: 15px;
      padding: 0 48px 0 16px;
      outline: none;
      transition: border-color .2s;
    }
    .search-input::placeholder { color: var(--muted); }
    .search-input:focus { border-color: var(--accent); }

    .search-clear {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
      line-height: 1;
      padding: 4px;
    }

    .search-btn {
      height: 48px;
      padding: 0 20px;
      background: var(--accent);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      flex-shrink: 0;
      transition: opacity .2s;
    }
    .search-btn:hover { opacity: .85; }
    .search-btn:disabled { opacity: .4; cursor: default; }

    .suggest-list {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: #1e2d45;
      border: 1px solid var(--border2);
      border-radius: 12px;
      overflow: hidden;
      z-index: 50;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    .suggest-item {
      padding: 12px 16px;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background .15s;
    }
    .suggest-item:last-child { border-bottom: none; }
    .suggest-item:hover { background: var(--surface2); }
    .suggest-item-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

    /* â”€â”€ States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .state-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      padding: 80px 20px;
      text-align: center;
    }

    .state-icon  { font-size: 56px; }
    .state-title { font-size: 20px; font-weight: 700; }
    .state-sub   { font-size: 14px; color: var(--muted); max-width: 300px; line-height: 1.6; }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Current weather card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .current-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 16px;
      backdrop-filter: blur(12px);
    }

    .city-name { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 2px; }
    .city-sub  { font-size: 13px; color: var(--muted); margin-bottom: 20px; }

    .current-main {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .weather-emoji { font-size: 64px; line-height: 1; }

    .temp-now {
      font-size: 68px;
      font-weight: 900;
      letter-spacing: -3px;
      line-height: 1;
    }

    .temp-feels  { font-size: 14px; color: var(--muted); margin-top: 4px; }
    .weather-desc { font-size: 18px; font-weight: 600; color: var(--muted); margin-top: 4px; }

    .stats-row {
      display: flex;
      border-top: 1px solid var(--border);
      padding-top: 18px;
    }

    .stat { flex: 1; text-align: center; border-right: 1px solid var(--border); }
    .stat:last-child { border-right: none; }
    .stat-val   { font-size: 20px; font-weight: 800; }
    .stat-label { font-size: 12px; color: var(--muted); margin-top: 3px; }

    /* â”€â”€ Forecast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .forecast-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .forecast-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    @media (max-width: 480px) {
      .forecast-grid { grid-template-columns: repeat(4, 1fr); }
    }

    .forecast-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 8px;
      text-align: center;
      backdrop-filter: blur(8px);
    }

    .fc-day  { font-size: 11px; color: var(--muted); margin-bottom: 6px; font-weight: 600; }
    .fc-icon { font-size: 22px; margin-bottom: 6px; }
    .fc-max  { font-size: 14px; font-weight: 800; }
    .fc-min  { font-size: 12px; color: var(--muted); margin-top: 2px; }

    .updated-time {
      font-size: 12px;
      color: var(--muted);
      text-align: right;
      margin-top: 12px;
      opacity: .6;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    /* â”€â”€â”€ êµ­ë‚´ ì£¼ìš” ë„ì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const KOREA_CITIES = [
      { name: 'ì„œìš¸',   lat: 37.5665,  lon: 126.9780 },
      { name: 'ë¶€ì‚°',   lat: 35.1796,  lon: 129.0756 },
      { name: 'ì¸ì²œ',   lat: 37.4563,  lon: 126.7052 },
      { name: 'ëŒ€êµ¬',   lat: 35.8714,  lon: 128.6014 },
      { name: 'ëŒ€ì „',   lat: 36.3504,  lon: 127.3845 },
      { name: 'ê´‘ì£¼',   lat: 35.1595,  lon: 126.8526 },
      { name: 'ìš¸ì‚°',   lat: 35.5384,  lon: 129.3114 },
      { name: 'ìˆ˜ì›',   lat: 37.2636,  lon: 127.0286 },
      { name: 'ê³ ì–‘',   lat: 37.6584,  lon: 126.8323 },
      { name: 'ì°½ì›',   lat: 35.2280,  lon: 128.6811 },
      { name: 'ì „ì£¼',   lat: 35.8242,  lon: 127.1479 },
      { name: 'ì²­ì£¼',   lat: 36.6424,  lon: 127.4890 },
      { name: 'ì²œì•ˆ',   lat: 36.8151,  lon: 127.1139 },
      { name: 'ì¶˜ì²œ',   lat: 37.8813,  lon: 127.7300 },
      { name: 'ê°•ë¦‰',   lat: 37.7519,  lon: 128.8760 },
      { name: 'í¬í•­',   lat: 36.0190,  lon: 129.3435 },
      { name: 'ëª©í¬',   lat: 34.8118,  lon: 126.3922 },
      { name: 'ì œì£¼',   lat: 33.4996,  lon: 126.5312 },
      { name: 'ì†ì´ˆ',   lat: 38.2070,  lon: 128.5919 },
      { name: 'ì—¬ìˆ˜',   lat: 34.7604,  lon: 127.6622 },
    ];

    /* â”€â”€â”€ WMO ë‚ ì”¨ ì½”ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const WMO = {
      0:  { emoji: 'â˜€ï¸',  label: 'ë§‘ìŒ',          bg: 'clear'   },
      1:  { emoji: 'ğŸŒ¤ï¸', label: 'ëŒ€ì²´ë¡œ ë§‘ìŒ',    bg: 'clear'   },
      2:  { emoji: 'â›…',  label: 'êµ¬ë¦„ ì¡°ê¸ˆ',      bg: 'cloudy'  },
      3:  { emoji: 'â˜ï¸',  label: 'íë¦¼',           bg: 'cloudy'  },
      45: { emoji: 'ğŸŒ«ï¸', label: 'ì•ˆê°œ',            bg: 'fog'     },
      48: { emoji: 'ğŸŒ«ï¸', label: 'ì§™ì€ ì•ˆê°œ',       bg: 'fog'     },
      51: { emoji: 'ğŸŒ¦ï¸', label: 'ì´ìŠ¬ë¹„',          bg: 'rain'    },
      53: { emoji: 'ğŸŒ¦ï¸', label: 'ì´ìŠ¬ë¹„',          bg: 'rain'    },
      55: { emoji: 'ğŸŒ¦ï¸', label: 'ì´ìŠ¬ë¹„',          bg: 'rain'    },
      61: { emoji: 'ğŸŒ§ï¸', label: 'ë¹„',              bg: 'rain'    },
      63: { emoji: 'ğŸŒ§ï¸', label: 'ë¹„',              bg: 'rain'    },
      65: { emoji: 'ğŸŒ§ï¸', label: 'ê°•í•œ ë¹„',         bg: 'rain'    },
      71: { emoji: 'ğŸŒ¨ï¸', label: 'ëˆˆ',              bg: 'snow'    },
      73: { emoji: 'ğŸŒ¨ï¸', label: 'ëˆˆ',              bg: 'snow'    },
      75: { emoji: 'â„ï¸',  label: 'ê°•í•œ ëˆˆ',        bg: 'snow'    },
      77: { emoji: 'ğŸŒ¨ï¸', label: 'ì‹¸ë½ëˆˆ',          bg: 'snow'    },
      80: { emoji: 'ğŸŒ¦ï¸', label: 'ì†Œë‚˜ê¸°',          bg: 'rain'    },
      81: { emoji: 'ğŸŒ§ï¸', label: 'ì†Œë‚˜ê¸°',          bg: 'rain'    },
      82: { emoji: 'â›ˆï¸',  label: 'ê°•í•œ ì†Œë‚˜ê¸°',    bg: 'rain'    },
      85: { emoji: 'ğŸŒ¨ï¸', label: 'ëˆˆ ì†Œë‚˜ê¸°',       bg: 'snow'    },
      86: { emoji: 'â„ï¸',  label: 'ê°•í•œ ëˆˆ ì†Œë‚˜ê¸°', bg: 'snow'    },
      95: { emoji: 'â›ˆï¸',  label: 'ë‡Œìš°',           bg: 'thunder' },
      96: { emoji: 'â›ˆï¸',  label: 'ë‡Œìš° + ìš°ë°•',    bg: 'thunder' },
      99: { emoji: 'â›ˆï¸',  label: 'ë‡Œìš° + ìš°ë°•',    bg: 'thunder' },
    };

    function getWmo(code) {
      return WMO[code] || { emoji: 'ğŸŒ¡ï¸', label: 'ì•Œ ìˆ˜ ì—†ìŒ', bg: 'clear' };
    }

    /* â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const DAYS = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

    function formatDay(dateStr, idx) {
      if (idx === 0) return 'ì˜¤ëŠ˜';
      return DAYS[new Date(dateStr).getDay()] + 'ìš”ì¼';
    }

    function toF(c) { return Math.round(c * 9/5 + 32); }

    function fmtTemp(c, isFahr) {
      return isFahr ? `${toF(c)}Â°F` : `${Math.round(c)}Â°C`;
    }

    function fmtSpeed(ms, isFahr) {
      return isFahr
        ? `${Math.round(ms * 2.237)} mph`
        : `${Math.round(ms * 3.6)} km/h`;
    }

    /* â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function geocode(city) {
      const res = await fetch(
        `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=5&language=en&format=json`
      );
      const data = await res.json();
      return data.results || [];
    }

    async function fetchWeather(lat, lon) {
      const params = [
        'current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation,weather_code,wind_speed_10m',
        'daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum',
        'timezone=auto',
        'wind_speed_unit=ms',
        `latitude=${lat}`,
        `longitude=${lon}`,
      ].join('&');
      const res = await fetch(`https://api.open-meteo.com/v1/forecast?${params}`);
      if (!res.ok) throw new Error('ë‚ ì”¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      return res.json();
    }

    /* â”€â”€â”€ Weather display components â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function CurrentCard({ data, location, isFahr }) {
      const { current } = data;
      const wmo = getWmo(current.weather_code);

      return (
        <div className="current-card">
          <div className="city-name">{location.name}</div>
          <div className="city-sub">
            {[location.admin1, location.country].filter(Boolean).join(', ')}
          </div>

          <div className="current-main">
            <div className="weather-emoji">{wmo.emoji}</div>
            <div>
              <div className="temp-now">
                {isFahr ? toF(current.temperature_2m) : Math.round(current.temperature_2m)}
                <span style={{ fontSize: '32px', fontWeight: 400 }}>
                  {isFahr ? 'Â°F' : 'Â°C'}
                </span>
              </div>
              <div className="weather-desc">{wmo.label}</div>
              <div className="temp-feels">ì²´ê° {fmtTemp(current.apparent_temperature, isFahr)}</div>
            </div>
          </div>

          <div className="stats-row">
            <div className="stat">
              <div className="stat-val">ğŸ’§ {current.relative_humidity_2m}%</div>
              <div className="stat-label">ìŠµë„</div>
            </div>
            <div className="stat">
              <div className="stat-val">ğŸ’¨ {fmtSpeed(current.wind_speed_10m, isFahr)}</div>
              <div className="stat-label">í’ì†</div>
            </div>
            <div className="stat">
              <div className="stat-val">ğŸŒ§ï¸ {current.precipitation}mm</div>
              <div className="stat-label">ê°•ìˆ˜ëŸ‰</div>
            </div>
          </div>
        </div>
      );
    }

    function ForecastRow({ daily, isFahr }) {
      return (
        <div>
          <div className="forecast-title">7ì¼ ì˜ˆë³´</div>
          <div className="forecast-grid">
            {daily.time.map((dateStr, i) => {
              const wmo = getWmo(daily.weather_code[i]);
              return (
                <div className="forecast-card" key={dateStr}>
                  <div className="fc-day">{formatDay(dateStr, i)}</div>
                  <div className="fc-icon">{wmo.emoji}</div>
                  <div className="fc-max">{fmtTemp(daily.temperature_2m_max[i], isFahr)}</div>
                  <div className="fc-min">{fmtTemp(daily.temperature_2m_min[i], isFahr)}</div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    /* â”€â”€â”€ Korea tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function KoreaTab({ onSelect, activeCity, loading }) {
      const [showCoord, setShowCoord] = useState(false);
      const [lat,       setLat]       = useState('');
      const [lon,       setLon]       = useState('');
      const [coordErr,  setCoordErr]  = useState('');

      function handleCityClick(city) {
        setShowCoord(false);
        setCoordErr('');
        onSelect(city);
      }

      function toggleCoordForm() {
        setShowCoord(v => !v);
        setCoordErr('');
      }

      function handleCoordSearch() {
        const latN = parseFloat(lat);
        const lonN = parseFloat(lon);
        if (isNaN(latN) || latN < -90  || latN > 90)  { setCoordErr('ìœ„ë„ëŠ” -90 ~ 90 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');   return; }
        if (isNaN(lonN) || lonN < -180 || lonN > 180) { setCoordErr('ê²½ë„ëŠ” -180 ~ 180 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.'); return; }
        setCoordErr('');
        onSelect({
          name:   `${latN.toFixed(4)}, ${lonN.toFixed(4)}`,
          admin1: 'ì§ì ‘ ì…ë ¥í•œ ì¢Œí‘œ',
          country: '',
          lat: latN,
          lon: lonN,
        });
      }

      return (
        <>
          <div className="city-grid">
            {KOREA_CITIES.map(city => (
              <button
                key={city.name}
                className={`city-btn${activeCity === city.name ? ' active' : ''}`}
                onClick={() => handleCityClick(city)}
                disabled={loading}
              >
                {city.name}
              </button>
            ))}
            <button
              className={`city-btn city-btn-manual${showCoord ? ' active' : ''}`}
              onClick={toggleCoordForm}
              disabled={loading}
            >
              ì§ì ‘ ì…ë ¥
            </button>
          </div>

          {showCoord && (
            <div className="coord-form">
              <div className="coord-inputs">
                <div className="coord-field">
                  <label className="coord-label">ìœ„ë„ (Latitude)</label>
                  <input
                    className="coord-input"
                    type="number"
                    step="0.0001"
                    placeholder="ì˜ˆ: 37.5665"
                    value={lat}
                    onChange={e => { setLat(e.target.value); setCoordErr(''); }}
                    onKeyDown={e => e.key === 'Enter' && handleCoordSearch()}
                    disabled={loading}
                  />
                </div>
                <div className="coord-field">
                  <label className="coord-label">ê²½ë„ (Longitude)</label>
                  <input
                    className="coord-input"
                    type="number"
                    step="0.0001"
                    placeholder="ì˜ˆ: 126.9780"
                    value={lon}
                    onChange={e => { setLon(e.target.value); setCoordErr(''); }}
                    onKeyDown={e => e.key === 'Enter' && handleCoordSearch()}
                    disabled={loading}
                  />
                </div>
              </div>
              {coordErr && <p className="coord-err">{coordErr}</p>}
              <button
                className="search-btn"
                style={{ alignSelf: 'flex-start', padding: '0 24px' }}
                onClick={handleCoordSearch}
                disabled={loading || !lat.trim() || !lon.trim()}
              >
                ê²€ìƒ‰
              </button>
            </div>
          )}
        </>
      );
    }

    /* â”€â”€â”€ Global tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function GlobalTab({ onSelect, loading }) {
      const [query,    setQuery]    = useState('');
      const [suggests, setSuggests] = useState([]);
      const debounceRef = useRef(null);
      const suggestRef  = useRef(null);

      // ì™¸ë¶€ í´ë¦­ ì‹œ ìë™ì™„ì„± ë‹«ê¸°
      useEffect(() => {
        function handler(e) {
          if (suggestRef.current && !suggestRef.current.contains(e.target)) {
            setSuggests([]);
          }
        }
        document.addEventListener('mousedown', handler);
        return () => document.removeEventListener('mousedown', handler);
      }, []);

      function handleInput(val) {
        setQuery(val);
        clearTimeout(debounceRef.current);
        if (!val.trim()) { setSuggests([]); return; }
        debounceRef.current = setTimeout(async () => {
          const results = await geocode(val);
          setSuggests(results.slice(0, 5));
        }, 350);
      }

      async function handleEnter() {
        if (suggests.length > 0) { handleSelect(suggests[0]); return; }
        if (!query.trim()) return;
        const results = await geocode(query);
        if (results.length) handleSelect(results[0]);
      }

      function handleSelect(loc) {
        setSuggests([]);
        setQuery(loc.name);
        onSelect({
          name: loc.name,
          admin1: loc.admin1 || '',
          country: loc.country || '',
          lat: loc.latitude,
          lon: loc.longitude,
        });
      }

      return (
        <div className="search-row">
          <div className="search-box" ref={suggestRef}>
            <input
              className="search-input"
              type="text"
              placeholder="Search city in English (e.g. Tokyo, Parisâ€¦)"
              value={query}
              onChange={e => handleInput(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && handleEnter()}
              disabled={loading}
            />
            {query && (
              <button className="search-clear" onClick={() => { setQuery(''); setSuggests([]); }}>âœ•</button>
            )}
            {suggests.length > 0 && (
              <div className="suggest-list">
                {suggests.map((s, i) => (
                  <div key={i} className="suggest-item" onClick={() => handleSelect(s)}>
                    <div>{s.name}</div>
                    <div className="suggest-item-sub">
                      {[s.admin1, s.country].filter(Boolean).join(', ')}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
          <button className="search-btn" onClick={handleEnter} disabled={loading || !query.trim()}>
            Search
          </button>
        </div>
      );
    }

    /* â”€â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function App() {
      const [tab,      setTab]      = useState('korea'); // 'korea' | 'global'
      const [location, setLocation] = useState(null);
      const [weather,  setWeather]  = useState(null);
      const [loading,  setLoading]  = useState(false);
      const [error,    setError]    = useState(null);
      const [isFahr,   setIsFahr]   = useState(false);
      const [locating, setLocating] = useState(false);
      const [activeCity, setActiveCity] = useState(null);

      // ë°°ê²½ í´ë˜ìŠ¤
      useEffect(() => {
        if (!weather) return;
        const wmo = getWmo(weather.current.weather_code);
        document.body.className = `bg-${wmo.bg}`;
        return () => { document.body.className = ''; };
      }, [weather]);

      async function loadWeather(lat, lon, loc) {
        setLoading(true);
        setError(null);
        try {
          const data = await fetchWeather(lat, lon);
          setLocation(loc);
          setWeather(data);
        } catch (e) {
          setError(e.message);
        } finally {
          setLoading(false);
        }
      }

      // êµ­ë‚´ ë„ì‹œ ì„ íƒ (city.countryê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ, ì—†ìœ¼ë©´ 'ëŒ€í•œë¯¼êµ­' ê¸°ë³¸ê°’)
      function handleKoreaSelect(city) {
        setActiveCity(city.name);
        loadWeather(city.lat, city.lon, {
          name:    city.name,
          admin1:  city.admin1  ?? '',
          country: city.country ?? 'ëŒ€í•œë¯¼êµ­',
        });
      }

      // ì „ì„¸ê³„ ê²€ìƒ‰ ì„ íƒ
      function handleGlobalSelect(loc) {
        setActiveCity(null);
        loadWeather(loc.lat, loc.lon, loc);
      }

      // ë‚´ ìœ„ì¹˜
      function handleGeolocate() {
        if (!navigator.geolocation) { setError('ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.'); return; }
        setLocating(true);
        navigator.geolocation.getCurrentPosition(
          async ({ coords }) => {
            try {
              setActiveCity(null);
              await loadWeather(coords.latitude, coords.longitude, {
                name: 'í˜„ì¬ ìœ„ì¹˜', admin1: '', country: '',
              });
            } finally { setLocating(false); }
          },
          () => { setError('ìœ„ì¹˜ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.'); setLocating(false); }
        );
      }

      // íƒ­ ì „í™˜ ì‹œ ë‚ ì”¨ ì´ˆê¸°í™”
      function switchTab(t) {
        setTab(t);
        setWeather(null);
        setLocation(null);
        setError(null);
        setActiveCity(null);
      }

      const updatedAt = weather
        ? new Date(weather.current.time).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
        : null;

      return (
        <div className="wrap">
          {/* íƒ­ + ì»¨íŠ¸ë¡¤ */}
          <div className="controls-row">
            <div className="tab-group">
              <button
                className={`tab-btn${tab === 'korea' ? ' active' : ''}`}
                onClick={() => switchTab('korea')}
              >êµ­ë‚´</button>
              <button
                className={`tab-btn${tab === 'global' ? ' active' : ''}`}
                onClick={() => switchTab('global')}
              >ì „ì„¸ê³„</button>
            </div>
            <div className="spacer" />
            <button
              className="loc-btn"
              onClick={handleGeolocate}
              disabled={locating}
              title="í˜„ì¬ ìœ„ì¹˜"
            >
              {locating ? 'â€¦' : 'ğŸ“'}
            </button>
            <button className="unit-btn" onClick={() => setIsFahr(f => !f)}>
              {isFahr ? 'Â°C' : 'Â°F'}
            </button>
          </div>

          {/* íƒ­ë³„ ì…ë ¥ ì˜ì—­ */}
          {tab === 'korea'
            ? <KoreaTab onSelect={handleKoreaSelect} activeCity={activeCity} loading={loading} />
            : <GlobalTab onSelect={handleGlobalSelect} loading={loading} />
          }

          {/* ë¡œë”© */}
          {loading && (
            <div className="state-center">
              <div className="spinner" />
              <p className="state-sub">ë‚ ì”¨ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>
            </div>
          )}

          {/* ì—ëŸ¬ */}
          {!loading && error && (
            <div className="state-center">
              <div className="state-icon">ğŸ˜•</div>
              <div className="state-title">ì˜¤ë¥˜ ë°œìƒ</div>
              <p className="state-sub">{error}</p>
            </div>
          )}

          {/* ì´ˆê¸° ì•ˆë‚´ */}
          {!loading && !error && !weather && (
            <div className="state-center">
              <div className="state-icon">{tab === 'korea' ? 'ğŸ‡°ğŸ‡·' : 'ğŸŒ'}</div>
              <div className="state-title">
                {tab === 'korea' ? 'ë„ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”' : 'ë„ì‹œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”'}
              </div>
              <p className="state-sub">
                {tab === 'korea'
                  ? 'ìœ„ ë²„íŠ¼ì—ì„œ ë„ì‹œë¥¼ ì„ íƒí•˜ë©´ ë‚ ì”¨ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
                  : 'ì˜ë¬¸ìœ¼ë¡œ ë„ì‹œëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ğŸ“ ë²„íŠ¼ìœ¼ë¡œ í˜„ì¬ ìœ„ì¹˜ ë‚ ì”¨ë¥¼ í™•ì¸í•˜ì„¸ìš”.'}
              </p>
            </div>
          )}

          {/* ë‚ ì”¨ ê²°ê³¼ */}
          {!loading && !error && weather && location && (
            <>
              <CurrentCard data={weather} location={location} isFahr={isFahr} />
              <ForecastRow daily={weather.daily} isFahr={isFahr} />
              {updatedAt && <p className="updated-time">ê¸°ì¤€ ì‹œê°: {updatedAt}</p>}
            </>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
